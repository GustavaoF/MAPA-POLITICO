<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Editor de Mapas SVG</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Roboto:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 2rem;
      background: linear-gradient(135deg, #1e1e70, #5e3ca4);
      color: #ffffff;
      text-align: center;
    }
    h1, h2 {
      font-family: 'Roboto', sans-serif;
      color: #e0d4ff;
      margin-bottom: 1rem;
    }
    p {
      margin: 0.5rem 0 1rem;
    }
    input[type=file], button {
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    button {
      background-color: #6a4fc7;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #5a3db1;
    }
    a {
      color: #ffdbfa;
      font-weight: bold;
      display: inline-block;
      margin-top: 1rem;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    hr {
      border: none;
      height: 2px;
      background: #a177ff;
      margin: 2rem auto;
      width: 80%;
    }
    img {
      margin-top: 3rem;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h1>Editor de Mapa Político (.svg)</h1>
  <p>1. Faça o upload de um arquivo <strong>.svg</strong> com mapa vetorial:</p>
  <input type="file" id="svgFile" accept=".svg">

  <p>2. Faça o upload de um arquivo <strong>.csv</strong> com colunas: <code>cod_mun,nome_mun,cor</code>:</p>
  <input type="file" id="csvFile" accept=".csv">

  <br>
  <button onclick="processFiles()">Gerar novo SVG</button>
  <br>
  <a id="downloadLink" style="display:none;" download="mapa_editado.svg">Baixar Mapa Editado</a>

  <hr>

  <h2>Extrair IDs e Labels do Mapa (.svg)</h2>
  <p>Envie um mapa político em formato <strong>.svg</strong> para gerar uma planilha:</p>
  <input type="file" id="extractFile" accept=".svg">
  <br>
  <button onclick="extractData()">Extrair para CSV</button>
  <br>
  <a id="csvDownloadLink" style="display:none;" download="municipios_extraidos.csv">Baixar CSV Gerado</a>

  <img src="https://upload.wikimedia.org/wikipedia/commons/4/4f/Bare_sole.jpg" alt="Sola de um pé">

  <script>
    async function processFiles() {
      const svgInput = document.getElementById('svgFile').files[0];
      const csvInput = document.getElementById('csvFile').files[0];

      if (!svgInput || !csvInput) {
        alert("Por favor, envie os dois arquivos.");
        return;
      }

      const svgText = await svgInput.text();
      const csvText = await csvInput.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(svgText, "image/svg+xml");

      const lines = csvText.split(/\r?\n/);
      const map = {};
      for (let i = 1; i < lines.length; i++) {
        const [cod_mun, nome_mun, cor] = lines[i].split(',');
        if (cod_mun && cor) map[cod_mun.trim()] = cor.trim();
      }

      const elements = xmlDoc.querySelectorAll("[id]");
      elements.forEach(el => {
        const id = el.getAttribute("id");
        if (map[id]) {
          let style = el.getAttribute("style") || "";
          let styles = Object.fromEntries(style.split(';').map(s => s.split(':')).filter(p => p.length === 2));
          styles.fill = map[id];
          el.setAttribute("style", Object.entries(styles).map(([k, v]) => `${k}:${v}`).join(';'));
        }
      });

      const serializer = new XMLSerializer();
      const editedSvg = serializer.serializeToString(xmlDoc);
      const blob = new Blob([editedSvg], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);

      const link = document.getElementById("downloadLink");
      link.href = url;
      link.style.display = "inline-block";
      link.textContent = "Baixar Mapa Editado";
    }

    async function extractData() {
      const fileInput = document.getElementById('extractFile').files[0];
      if (!fileInput) {
        alert("Envie um arquivo SVG primeiro.");
        return;
      }

      const svgText = await fileInput.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(svgText, "image/svg+xml");

      const rows = [['cod_mun', 'nome_mun', 'cor']];
      const elements = xmlDoc.querySelectorAll("[id]");
      elements.forEach(el => {
        const id = el.getAttribute("id") || "";
        let label = el.getAttribute("label") || "";

        if (!label) {
          for (let attr of el.attributes) {
            if (attr.name.endsWith(":label")) {
              label = attr.value;
              break;
            }
          }
        }

        rows.push([id, label, ""]);
      });

      const csvContent = rows.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const link = document.getElementById("csvDownloadLink");
      link.href = url;
      link.style.display = "inline-block";
      link.textContent = "Baixar CSV Gerado";
    }
  </script>
</body>
</html>
